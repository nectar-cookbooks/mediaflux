#!/bin/sh
#
# Take a backup of the Mediaflux database and all assets
# and (optionally) rsync the backups to an "replica" location.
#

if [ -e /etc/mediaflux/servicerc ] ; then
    . /etc/mediaflux/servicerc
fi

DIR="<%= @backup_dir %>"
LOG="$MFLUX_HOME/volatile/logs/backups.log"
REPLICA="<%= @replica %>"
STORE="<%= @store %>"
KEEP_DAYS="<%= @keep_days %>"

echo >> $LOG
echo "*** Starting mediaflux backup run - " `date` >> $LOG

echo "Cleaning old backups" >> $LOG
find $DIR -type f -ctime +$KEEP_DAYS -exec rm -v {} \; >> $LOG 2>&1
echo "Cleaning empty backup dirs" >> $LOG
find $DIR -mindepth 1 -type d -empty -exec rmdir -v {} \; >> $LOG 2>&1

TODAY=`date +%F`
TODAY_DIR=$DIR/$TODAY

if [ ! -e $TODAY ] ; then
    echo "Creating backup directory $TODAY_DIR" >> $LOG
    mkdir $TODAY_DIR
    chown $MFLUX_SYSTEM_USER:$MFLUX_SYSTEM_USER $TODAY_DIR
    chmod 750 $TODAY_DIR
fi

echo "Running mediaflux backups for $TODAY" >> $LOG
MF_COMMAND="$MFLUX_BIN/mfcommand"
$MF_COMMAND logon $MFLUX_DOMAIN $MFLUX_USER "$MFLUX_PASSWORD" >> $LOG 2>&1
$MF_COMMAND source -dir=$TODAY_DIR $MFLUX_HOME/config/backup.tcl >> $LOG 2>&1
RC=$?
$MF_COMMAND logoff >> $LOG 2>&1

if [ $RC -eq 0 ] ; then
    echo "*** Backup for $TODAY completed - " `date` >> $LOG
else
    echo "*** Backup for $TODAY failed - " `date` >> $LOG
    echo "Mediaflux backup for $TODAY failed; see log file"
    exit $RC
fi

if [ ! -z "$REPLICA" ] ; then
    echo "Replicating backups to " $REPLICA >> $LOG
    OPTS="-av --delete-before"
    rsync $OPTS $DIR $REPLICA >> $LOG 2>&1
    RC=$?
    if [ $RC -ne 0 ] ; then
	echo "*** Backup replication failed - " `date` >> $LOG
	echo "Mediaflux backup replication failed; see log file"
    else
	echo "*** Backup replication completed - " `date` >> $LOG
    fi
fi

if [ ! -z "$STORE" ] ; then
    echo "Exporting backup to Object Store " $STORE >> $LOG
    . /etc/mflux/openstackrc
    RC=`( cd $DIR ; swift upload $STORE . >> $LOG ; echo $?)`
    if [ $RC -ne 0 ] ; then
	echo "*** Backup save to Swift failed - " `date` >> $LOG
	echo "Mediaflux backup save to Swift failed; see log file"
    else
	echo "*** Backup save to Swift completed - " `date` >> $LOG
    fi 
fi

exit $RC
