#!/bin/sh
#
# Perform a DaRIS backup.
#

if [ -e /etc/mediaflux/servicerc ] ; then
    . /etc/mediaflux/servicerc
fi

DIR=<%= @backup_dir %>
LOG=$MFLUX_HOME/volatile/logs/backups.log
REPLICA=<%= @replica %>
KEEP_DAYS=<%= @keep_days %>

find $DIR -type f -ctime -$KEEP_DAYS -exec rm {} ";"
find $DIR -mindepth 1 -type d -ctime -$KEEP_DAYS \
    -exec rmdir --ignore-fail-on-non-empty "{}" ";"

TODAY=${DIR}/`date +%F`

if [ ! -e $TODAY ] ; then
    mkdir $TODAY
    chown $MFLUX_SYSTEM_USER:$MFLUX_SYSTEM_USER $TODAY
fi

MF_COMMAND="$MFLUX_BIN/mfcommand"
$MF_COMMAND logon $MFLUX_DOMAIN $MFLUX_USER "$MFLUX_PASSWORD"
$MF_COMMAND source -dir=$TODAY $MFLUX_HOME/config/daris_backup.tcl
RC=$?
$MF_COMMAND logoff

if [ ! -z "$REPLICA" -a $RC -eq 0 ] ; then
    if [ `expr match $REPLICA ".+:"` -eq 0 ] ; then 
        rsync -av --compress-level=0 --dry-run --delete-before $DIR $REPLICA
	RC=$?
    else
        rsync -av --dry-run --delete-before $DIR $REPLICA
	RC=$?
    fi
fi

exit $RC
